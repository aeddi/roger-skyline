# Install Packages
- apt: name=slapd state=present
- apt: name=ldap-utils state=present
- apt: name=ssl-cert state=present
- apt: name=gnutls-bin state=present

# Configure slapd pkg
- debconf: name='slapd' question='slapd/password1' value='{{ldap_passwd}}' vtype='password'
- debconf: name='slapd' question='slapd/internal/generated_adminpw' value='{{ldap_passwd}}' vtype='password'
- debconf: name='slapd' question='slapd/password2' value='{{ldap_passwd}}' vtype='password'
- debconf: name='slapd' question='slapd/internal/adminpw' value='{{ldap_passwd}}' vtype='password'
- debconf: name='slapd' question='slapd/backend' value='MDB' vtype='string'
- debconf: name='slapd' question='slapd/move_old_database' value='false' vtype='boolean'
- debconf: name='slapd' question='slapd/domain' value='slash16.local' vtype='string'

# Create ldap cert and key
- copy: src=ldap_server.conf dest=/etc/ssl/templates/ldap_server.conf
- command: certtool -p --sec-param high --outfile /etc/ssl/private/ldap_server.key
- command: certtool -c --load-privkey /etc/ssl/private/ldap_server.key --load-ca-certificate /etc/ssl/certs/ca_certs.pem --load-ca-privkey /etc/ssl/private/ca_certs.key --template /etc/ssl/templates/ldap_server.conf --outfile /etc/ssl/certs/ldap_server.pem

# Configure ldap ssl
- copy: src=slapd dest=/etc/default/slapd

- command: usermod -aG ssl-cert openldap
- command: chown :ssl-cert /etc/ssl/private/ldap_server.key
- command: chmod 640 /etc/ssl/private/ldap_server.key

- copy: src=addcerts.ldif dest=/root/addcerts.ldif
- command: chown openldap:openldap /root/addcerts.ldif
- command: ldapmodify -Y EXTERNAL -H ldapi:/// -f /root/addcerts.ldif

# Restart slapd
- name: restart slapd
  service: name=slapd state=restarted enabled=yes
