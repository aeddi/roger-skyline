- name: configure slapd package installation
  debconf:
    name='slapd' question='slapd/password1' value='{{ldap_root_passwd}}' vtype='password'
  debconf:
    name='slapd' question='slapd/internal/generated_adminpw' value='{{ldap_root_passwd}}' vtype='password'
  debconf:
    name='slapd' question='slapd/password2' value='{{ldap_root_passwd}}' vtype='password'
  debconf:
    name='slapd' question='slapd/internal/adminpw' value='{{ldap_root_passwd}}' vtype='password'
  debconf:
    name='slapd' question='slapd/backend' value='MDB' vtype='string'
  debconf:
    name='slapd' question='slapd/move_old_database' value='false' vtype='boolean'
  debconf:
    name='slapd' question='slapd/domain' value='slash16.local' vtype='string'
 
- name: install slapd package
  apt:
    name=slapd state=present
  apt:
    name=ldap-utils state=present
  apt:
    name=ssl-cert state=present
  apt:
    name=gnutls-bin state=present

- name: enable slapd
  service:
    name=slapd enabled=yes

- name: copy files
  copy:
    src=ldap.conf dest=/etc/ldap/ldap.conf
  copy:
    src=slapd dest=/etc/default/slapd
  copy:
    src=olcSSL.ldif dest=/root/olcSSL.ldif
  copy:
    src=ssl/templates dest=/etc/ssl

- name: configure ssl
  command: certtool -p --outfile /etc/ssl/private/ca_server.key
  command: certtool -s --load-privkey /etc/ssl/private/ca_server.key --template /etc/ssl/templates/ca_server.conf --outfile /etc/ssl/certs/ca_server.pem
  command: certtool -p --sec-param high --outfile /etc/ssl/private/ldap_server.key
  command: certtool -c --load-privkey /etc/ssl/private/ldap_server.key --load-ca-certificate /etc/ssl/certs/ca_server.pem --load-ca-privkey /etc/ssl/private/ca_server.key --template /etc/ssl/templates/ldap_server.conf --outfile /etc/ssl/certs/ldap_server.pem
  command: chown openldap:openldap /root/olcSSL.ldif
  command: ldapmodify -Y EXTERNAL -H ldapi:/// -f /root/olcSSL.ldif
      

- name: restart slapd
  service:
    name=slapd state=restarted
